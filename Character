using UnityEngine;

[RequireComponent(typeof(Rigidbody))]
public class Character : Identity
{
    int _health;
    public int health
    {
        get { return _health; }
        protected set { _health = Mathf.Clamp(value, 0, maxHealth); }
    }
    public int maxHealth = 100;
    public int Damage = 10;
    public float movementSpeed;
    protected Animator animator;
    protected Rigidbody rb;
    Quaternion newRotation;

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    public override void SetUP()
    {
        base.SetUP();
        health = maxHealth;
        rb = GetComponent<Rigidbody>();

        // --- แก้ไขจุดที่ 1: การหา Animator ---
        // ใช้ GetComponentInChildren เพื่อหาในลูกด้วย แต่ถ้าไม่เจอก็ไม่เป็นไร (ไม่ Error)
        animator = GetComponentInChildren<Animator>();

        // ลบ Debug.LogError ออก เพราะ FPS Controller แบบแคปซูลมักจะไม่มี Animator อยู่แล้ว
        if (animator == null)
        {
            // Debug.LogWarning("No Animator found on " + gameObject.name + " (This is okay for FPS Controller)");
        }
    }

    public void TakeDamage(int amount)
    {
        health -= amount;
        if (health <= 0)
        {
            Destroy(gameObject);
        }
    }

    public void Heal(int amount)
    {
        health += amount;
    }

    protected virtual void Turn(Vector3 direction)
    {
        if (direction == Vector3.zero) return;

        // หันเฉพาะตอนเดินหน้า
        if (Input.GetAxis("Vertical") > 0)
        {
            newRotation = Quaternion.LookRotation(direction);
            transform.rotation = Quaternion.Slerp(transform.rotation, newRotation, Time.deltaTime * 15f);
        }
    }

    protected virtual void Move(Vector3 direction)
    {
        Vector3 move = direction * movementSpeed * Time.fixedDeltaTime;
        rb.MovePosition(transform.position + move);

        // --- แก้ไขจุดที่ 2: เช็คก่อนสั่ง Animator ---
        // ใส่ if ดักไว้ ถ้าไม่มี Animator (เป็น null) ก็ข้ามไปเลย ไม่ต้อง Error
        if (animator != null)
        {
            animator.SetFloat("Speed", move.magnitude);
        }
    }
}
