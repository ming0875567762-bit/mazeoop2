using UnityEngine;

public class DoorController : MonoBehaviour
{
    [Header("Settings")]
    public int requiredKeys = 5;       // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
    public float openAngle = 90f;      // ‡∏≠‡∏á‡∏®‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏õ‡∏¥‡∏î
    public float openSpeed = 2f;       // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î

    private bool isOpen = false;       // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏ï‡∏π
    private bool isPlayerNearby = false; // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏∞‡πÉ‡∏ä‡πâ FindObjectOfType ‡∏´‡∏≤‡πÄ‡∏≠‡∏≤)
    private PlayerInventory playerRef;

    void Update()
    {
        // 1. ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ + ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î + ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° E
        if (isPlayerNearby && !isOpen && Input.GetKeyDown(KeyCode.E))
        {
            CheckKeysAndOpen();
        }

        // 2. ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î (isOpen = true) ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡∏´‡∏°‡∏∏‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π
        if (isOpen)
        {
            Quaternion targetRotation = Quaternion.Euler(0, openAngle, 0);
            transform.localRotation = Quaternion.Slerp(transform.localRotation, targetRotation, Time.deltaTime * openSpeed);
        }
    }

    void CheckKeysAndOpen()
    {
        // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ô‡∏ä‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
        if (playerRef == null)
        {
            playerRef = FindObjectOfType<PlayerInventory>();
        }

        if (playerRef != null)
        {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ keyCount
            if (playerRef.keyCount >= requiredKeys)
            {
                WinGame();
            }
            else
            {
                int missing = requiredKeys - playerRef.keyCount;
                Debug.Log($"üîí ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏Ç‡∏≤‡∏î‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏≠‡∏µ‡∏Å {missing} ‡∏î‡∏≠‡∏Å (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà {playerRef.keyCount})");
            }
        }
        else
        {
            Debug.LogError("‚ùå Error: ‡∏´‡∏≤ Script 'PlayerInventory' ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢‡πÉ‡∏ô‡∏â‡∏≤‡∏Å‡∏ô‡∏µ‡πâ!");
        }
    }

    void WinGame()
    {
        isOpen = true;
        Debug.Log("üéâ ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏™‡∏π‡πà‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞! üéâ");
    }

    void OnTriggerEnter(Collider other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = true;

            // ----------------- üî• ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î üî• -----------------
            // ‡πÉ‡∏ä‡πâ FindObjectOfType ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Script ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° 
            // ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡∏Å‡πá‡∏à‡∏∞‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
            playerRef = FindObjectOfType<PlayerInventory>();
            // ----------------------------------------------------

            Debug.Log("Press [E] to Open Door");
        }
    }

    void OnTriggerExit(Collider other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerNearby = false;
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á playerRef ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
        }
    }
}
